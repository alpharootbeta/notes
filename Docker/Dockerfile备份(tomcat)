FROM sub-centos

#MAINTAINER Xi Jiang "jxi@hotmail.com"

#RUN mkdir -p /usr/lib/jvm

#ADD jdk-7u75-linux-x64.tar.gz /usr/lib/jvm

#RUN echo '#set java environment' >> /etc/profile \
#    && echo 'export JAVA_HOME=/usr/lib/jvm/jdk1.7.0_75' >> /etc/profile \
#    && echo 'export JRE_HOME=${JAVA_HOME}/jre' >> /etc/profile \
#    && echo 'export CLASSPATH=.:${JAVA_HOME}/lib:${JRE_HOME}/lib' >> /etc/profile \
#    && echo 'export PATH=${JAVA_HOME}/bin:$PATH' >> /etc/profile \
#    && update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk1.7.0_75/bin/java 300 \
#    && update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk1.7.0_75/bin/javac 300

#ADD apache-tomcat-6.0.43.tar.gz /usr/lib/jvm

#RUN echo 'JAVA_HOME=/usr/lib/jvm/jdk1.7.0_75' >> /usr/lib/jvm/apache-tomcat-6.0.43/bin/catalina.sh \
#    && sed -i "s/Connector port=\"8080\"/Connector port=\"9090\"/" /usr/lib/jvm/apache-tomcat-6.0.43/conf/server.xml
#RUN yum clean all \
#    && yum update -y \
#    && yum install subversion -y \
#    && yum install unzip -y
#ADD play-1.2.5.2.zip /root/
#WORKDIR /root/
#RUN unzip play-1.2.5.2.zip \
#    && rm -rf play-1.2.5.2.zip \
#    && chmod 755 /root/play-1.2.5.2
#ENV PATH /root/play-1.2.5.2:$PATH
#    && echo 'PATH=/root/play-1.2.5.2:$PATH' >> /etc/profile

#RUN mkdir -p /var/branch/ticomm \
#    && svn checkout https://192.168.1.168:8080/svn/Project/branches/ticomm2771_V3R06 /var/branch/ticomm --username xn.yang --password sdncloudtiger --non-interactive --trust-server-cert
WORKDIR /usr/lib/jvm/apache-tomcat-6.0.43/bin
ENV SVN_Version=""
ENV OPENSTACK_IP="192.168.1.202"
ENV LANG="en_US.UTF-8"
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
RUN     /bin/echo -e "ZONE="Asia/Shanghai"\nUTC=false\nRTC=false" > /etc/sysconfig/clock
#RUN     /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
#RUN     /bin/echo -e "ZONE="Asia/Shanghai"\nUTC=false\nRTC=false" > /etc/sysconfig/clock
ENTRYPOINT svn checkout ${SVN_Version} https://192.168.1.168:8080/svn/Project/branches/ticomm2771_V3R06 /var/branch/ticomm --username xn.yang --password sdncloudtiger  \
    && rm -rf /opt/ticomm/ \
    && play war /var/branch/ticomm  -o /opt/ticomm \
    && cp -a -f /opt/ticomm/WEB-INF /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/ \
    && rm -rf /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/public/licensefile \
    && rm -rf /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/lib/bcprov-jdk15-1.45.jar \
    && rm -rf /var/branch/ticomm/* \
    && sed -i "s%^keystone_auth_url.*$%keystone_auth_url=http://${OPENSTACK_IP}:5000/v2.0%" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && sed -i "s%^keystone_endpoint.*$%keystone_endpoint=http://${OPENSTACK_IP}:5000/v2.0%" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && sed -i "s%^neutron_endpoint.*$%neutron_endpoint=http://${OPENSTACK_IP}:9696/v2.0%" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && sed -i "s%^nova_endpoint.*$%nova_endpoint=http://${OPENSTACK_IP}:8774/v2%" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && sed -i "s%^ceilometer_endpoint.*$%ceilometer_endpoint=http://${OPENSTACK_IP}:8777/v2%" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && sed -i "s/localhost:3306/ticomm-db:3306/" /usr/lib/jvm/apache-tomcat-6.0.43/webapps/ROOT/WEB-INF/application/conf/application.conf \
    && ./startup.sh \
    && tail -f /usr/lib/jvm/apache-tomcat-6.0.43/logs/catalina.out
